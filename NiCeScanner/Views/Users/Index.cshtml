@model NiCeScanner.Controllers.PaginatedViewModel<NiCeScanner.Models.UserRolesViewModel>

<h1>@ViewData["Title"]</h1>

<div class="justify-content-between d-flex">
    <div class="search-container mb-4">
        <form id="searchForm" asp-action="Index" method="get">
            <div class="input-group">
                <input id="searchInput" type="text" class="form-control" name="searchString" value="@ViewData["CurrentFilter"]" placeholder="Search...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="table-container">
    <table id="usersTable" class="table mb-2">
        <thead>
        <tr>
            <th>
                <a asp-action="Index"
                   asp-route-searchString="@ViewData["SearchString"]"
                   asp-route-sortOrderEmail="@ViewData["EmailSortParm"]"
                >
                    Email address
                    @if (ViewData["SortOrderEmail"] != null && ViewData["SortOrderEmail"].ToString() == "Email_desc")
                    {
                    <span>&darr;</span>
                    }
                    else if (ViewData["SortOrderEmail"] != null && ViewData["SortOrderEmail"].ToString() == "Email")
                    {
                    <span>&uarr;</span>
                    }
                </a>
            </th>
            <th>Assigned roles</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in Model.Items)
        {
        <tr>
            <td>@Html.DisplayFor(modelItem => item.UserName)</td>
            <td>@Html.DisplayFor(modelItem => item.Roles)</td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                @if (item.IsPendingRoleRequest)
                {
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#roleRequestModal" data-username="@item.UserName" data-role="@item.RequestedRole" data-reason="@item.RequestReason" data-userid="@item.Id">
                    Pending Request
                </button>
                }
            </td>
        </tr>
        }
        </tbody>
    </table>

    @{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
    }

    <div>
        <nav aria-label="Page navigation">
            <ul class="pagination mb-2">
                <li class="page-item @prevDisabled">
                    <a class="page-link" asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@(Model.PageNumber - 1)"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]">Previous</a>
                </li>
                <li class="page-item @(1 == Model.PageNumber ? "active" : "")">
                    <a class="page-link" asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="1"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]">1</a>
                </li>
                @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                {
                if (i > 1 && i < Model.TotalPages)
                {
                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                    <a class="page-link" asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@i"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]">@i</a>
                </li>
                }
                }
                <li class="page-item @(Model.TotalPages == Model.PageNumber ? "active" : "")">
                    <a class="page-link" asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@Model.TotalPages"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]">@Model.TotalPages</a>
                </li>
                <li class="page-item @nextDisabled">
                    <a class="page-link" asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@(Model.PageNumber + 1)"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]">Next</a>
                </li>
            </ul>
        </nav>
    </div>

</div>

<!-- Modal -->
<div class="modal fade" id="roleRequestModal" tabindex="-1" role="dialog" aria-labelledby="roleRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleRequestModalLabel">Role Request Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Username:</strong> <span id="modalUsername"></span></p>
                <p><strong>Requested Role:</strong> <span id="modalRole"></span></p>
                <p><strong>Reason:</strong> <span id="modalReason"></span></p>
                <input type="hidden" id="modalUserId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="approveButton">Approve</button>
                <button type="button" class="btn btn-danger" id="denyButton">Deny</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#roleRequestModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var username = button.data('username');
            var role = button.data('role');
            var reason = button.data('reason');
            var userId = button.data('userid');

            var modal = $(this);
            modal.find('#modalUsername').text(username);
            modal.find('#modalRole').text(role);
            modal.find('#modalReason').text(reason);
            modal.find('#modalUserId').val(userId);
        });

        $('#approveButton').on('click', function () {
            var userId = $('#modalUserId').val();
            handleRoleRequest(userId, true);
        });

        $('#denyButton').on('click', function () {
            var userId = $('#modalUserId').val();
            handleRoleRequest(userId, false);
        });

        function handleRoleRequest(userId, isApproved) {
            $.ajax({
                url: '@Url.Action("HandleRoleRequest", "Users")',
                type: 'POST',
                data: {
                    userId: userId,
                    isApproved: isApproved
                },
                success: function () {
                    location.reload();
                },
                error: function () {
                    alert('An error occurred while processing the request.');
                }
            });
        }
    </script>
}
